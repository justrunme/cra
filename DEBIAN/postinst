#!/bin/bash
set -e

SCRIPT_PATH="/usr/local/bin/update-all"
REPO_LIST="$HOME/.repo-autosync.list"
CONFIG_FILE="$HOME/.create-repo.conf"

# üìÇ –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –Ω–µ—Ç
if [ ! -f "$REPO_LIST" ]; then
  echo "üìÑ –°–æ–∑–¥–∞—é —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è: $REPO_LIST"
  touch "$REPO_LIST"
fi

# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if [ ! -f "$CONFIG_FILE" ]; then
  echo "üìÑ –°–æ–∑–¥–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: $CONFIG_FILE"
  echo "default_cron_interval=1" > "$CONFIG_FILE"
  echo "default_visibility=public" >> "$CONFIG_FILE"
  echo "default_team=" >> "$CONFIG_FILE"
fi

# ‚è± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ cron
interval=$(grep default_cron_interval "$CONFIG_FILE" | cut -d= -f2)
interval=${interval:-1}
if ! crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"; then
  (crontab -l 2>/dev/null; echo "*/$interval * * * * $SCRIPT_PATH # auto-sync by create-repo") | sort -u | crontab -
  echo "‚úÖ Cron-–∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: –∫–∞–∂–¥—ã–µ $interval –º–∏–Ω"
else
  echo "‚ÑπÔ∏è Cron-–∑–∞–¥–∞—á–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# üß≠ –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ (—É–¥–æ–±–Ω—ã–π –∞–ª–∏–∞—Å)
ln -sf /usr/local/bin/create-repo /usr/local/bin/cra

# üéâ –§–∏–Ω–∞–ª
echo ""
echo "üì¶ create-repo —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
echo "üîÅ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ cron –∞–∫—Ç–∏–≤–Ω–∞"
echo "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $CONFIG_FILE"
