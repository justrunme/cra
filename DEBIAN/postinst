#!/bin/bash
set -e

SCRIPT_PATH="/usr/local/bin/update-all"
REPO_LIST="$HOME/.repo-autosync.list"
CONFIG_FILE="$HOME/.create-repo.conf"

# üóÇÔ∏è –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –Ω–µ—Ç
if [ ! -f "$REPO_LIST" ]; then
  echo "üìÑ –°–æ–∑–¥–∞—é $REPO_LIST"
  touch "$REPO_LIST"
fi

# ‚öôÔ∏è –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ñ–∏–≥, –µ—Å–ª–∏ –Ω–µ—Ç
if [ ! -f "$CONFIG_FILE" ]; then
  echo "üìÑ –°–æ–∑–¥–∞—é –∫–æ–Ω—Ñ–∏–≥: $CONFIG_FILE"
  echo "default_cron_interval=1" > "$CONFIG_FILE"
  echo "default_visibility=public" >> "$CONFIG_FILE"
fi

# üïí –î–æ–±–∞–≤–ª—è–µ–º –≤ crontab (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
if ! crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"; then
  interval=$(grep default_cron_interval "$CONFIG_FILE" | cut -d= -f2)
  interval=${interval:-1}
  (crontab -l 2>/dev/null; echo "*/$interval * * * * $SCRIPT_PATH") | sort -u | crontab -
  echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –≤ cron: $SCRIPT_PATH (–∫–∞–∂–¥—ã–µ $interval –º–∏–Ω)"
else
  echo "‚ÑπÔ∏è –ó–∞–¥–∞—á–∞ —É–∂–µ –µ—Å—Ç—å –≤ crontab."
fi

# üéâ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
echo ""
echo "üì¶ create-repo —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
echo "üõ† –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ —á–µ—Ä–µ–∑ cron."
echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏: $CONFIG_FILE"
