#!/bin/bash
set -e

# ðŸŽ¨ Colors
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
BLUE="\e[34m"
RESET="\e[0m"

# ðŸ“ Paths
CONFIG_FILE="$HOME/.create-repo.conf"
LOCAL_CONF=".create-repo.local.conf"
PLATFORM_MAP="$HOME/.create-repo.platforms"
REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
ERROR_LOG="$HOME/.create-repo-errors.log"
SCRIPT_PATH="/usr/local/bin/update-all"
NOW=$(date "+%Y-%m-%d %H:%M:%S")

# ðŸ§© Load global config if present
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"
[ -f "$LOCAL_CONF" ] && source "$LOCAL_CONF"

# ðŸ” Flags
show_help=false
run_update=false
run_sync_now=false
repo=""
custom_platform=""

# ðŸš© Argument parsing
while [[ $# -gt 0 ]]; do
  case "$1" in
    --help|-h) show_help=true ; shift ;;
    --update|--self-update) run_update=true ; shift ;;
    --sync-now) run_sync_now=true ; shift ;;
    --platform=*) custom_platform="${1#*=}" ; shift ;;
    *) repo=$1 ; shift ;;
  esac
done

# ðŸ†˜ Help
if $show_help; then
  echo -e "${BLUE}create-repo â€” Automate Git repo creation and syncing${RESET}"
  echo "Usage: create-repo [name] [flags]"
  echo "Flags:"
  echo "  --sync-now        Run sync now"
  echo "  --platform=...    Force platform (github/gitlab/bitbucket)"
  echo "  --update          Self-update"
  echo "  --help            Show help"
  exit 0
fi

# ðŸ”„ Self-update
if $run_update; then
  echo -e "${BLUE}Checking for updates...${RESET}"
  latest_version=$(curl -s https://api.github.com/repos/justrunme/cra/releases/latest | jq -r '.tag_name' | sed 's/^v//')
  current_version=$(dpkg -s create-repo 2>/dev/null | grep '^Version:' | awk '{print $2}')
  echo "Installed: ${YELLOW}${current_version:-none}${RESET}, Latest: ${GREEN}${latest_version}${RESET}"

  if [[ "$latest_version" != "$current_version" && -n "$latest_version" ]]; then
    tmp_deb=$(mktemp)
    url=$(curl -s https://api.github.com/repos/justrunme/cra/releases/latest | jq -r '.assets[] | select(.name | endswith(".deb")) | .browser_download_url')
    echo -e "${BLUE}Downloading update...${RESET}"
    curl -L "$url" -o "$tmp_deb"
    sudo dpkg -i "$tmp_deb" && echo -e "${GREEN}Updated!${RESET}"
    rm -f "$tmp_deb"
  else
    echo -e "${BLUE}You're up to date.${RESET}"
  fi
  exit 0
fi

# ðŸ›  Sync now
if $run_sync_now; then
  echo -e "${BLUE}ðŸ” Running sync now...${RESET}"
  "$SCRIPT_PATH"
  exit $?
fi

# ðŸ›¡ Pre-check: required tools
for tool in git curl jq; do
  command -v "$tool" &>/dev/null || {
    echo -e "${RED}âŒ Missing required tool: $tool${RESET}"
    exit 1
  }
done

# ðŸ§  Determine repo name
repo=${repo:-$(basename "$PWD")}

# ðŸŒ Platform detection
detect_platforms=()

command -v gh &>/dev/null && detect_platforms+=("github")
[ -n "$GITLAB_TOKEN" ] && detect_platforms+=("gitlab")
[ -n "$BITBUCKET_USERNAME" ] && [ -n "$BITBUCKET_APP_PASSWORD" ] && detect_platforms+=("bitbucket")

platform=""

# ðŸ—‚ Check platform binding to folder
if grep -qF "$PWD|" "$PLATFORM_MAP" 2>/dev/null; then
  platform=$(grep -F "$PWD|" "$PLATFORM_MAP" | cut -d'|' -f2)
fi

# âš™ï¸ If custom flag provided
if [[ -n "$custom_platform" ]]; then
  platform="$custom_platform"
  sed -i "/^$PWD|/d" "$PLATFORM_MAP" 2>/dev/null || true
  echo "$PWD|$platform" >> "$PLATFORM_MAP"
fi

# ðŸ¤– Ask user if multiple detected and no platform chosen
if [[ ${#detect_platforms[@]} -gt 1 && -z "$platform" ]]; then
  echo -e "${YELLOW}Multiple platforms detected: ${detect_platforms[*]}${RESET}"
  echo -ne "${BLUE}Which one to use for this folder? [github/gitlab/bitbucket]: ${RESET}"
  read platform_input
  platform=$platform_input
  echo "$PWD|$platform" >> "$PLATFORM_MAP"
  echo -e "${GREEN}Saved platform binding for this folder.${RESET}"
  echo -e "${YELLOW}Tip: use --platform= to override for a folder.${RESET}"
fi

# â— Error if still unknown
if [[ -z "$platform" ]]; then
  echo -e "${RED}âŒ Could not detect any platform or token!${RESET}"
  exit 1
fi

# ðŸš€ Git init
[ ! -d .git ] && git init && git checkout -b main

if git remote get-url origin &>/dev/null; then
  echo -e "${YELLOW}ðŸ“¥ Pulling from existing origin...${RESET}"
  git pull origin "$(git symbolic-ref --short HEAD)" || true
fi

# ðŸ“„ Init files
[ ! -f README.md ] && echo "# $repo" > README.md
[ ! -f .gitignore ] && echo ".DS_Store" > .gitignore

git add .
git commit -m "Initial commit at $NOW" &>/dev/null || true

# ðŸ”— Create remote repo
if [[ "$platform" == "github" ]]; then
  user=$(gh api user --jq .login)
  remote_url="git@github.com:$user/$repo.git"
  gh repo view "$repo" &>/dev/null || gh repo create "$repo" --public --source=. --push
elif [[ "$platform" == "gitlab" ]]; then
  resp=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
    --data "name=$repo&visibility=public" https://gitlab.com/api/v4/projects)
  remote_url=$(echo "$resp" | jq -r '.ssh_url_to_repo')
elif [[ "$platform" == "bitbucket" ]]; then
  curl -s -u "$BITBUCKET_USERNAME:$BITBUCKET_APP_PASSWORD" \
    -X POST "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_USERNAME/$repo" \
    -H "Content-Type: application/json" \
    -d '{"scm":"git","is_private":false}'
  remote_url="git@bitbucket.org:$BITBUCKET_USERNAME/$repo.git"
fi

git remote get-url origin &>/dev/null || git remote add origin "$remote_url"
git push -u origin "$(git symbolic-ref --short HEAD)" &>/dev/null || true

# ðŸ“ Track
grep -qxF "$PWD" "$REPO_LIST" || echo "$PWD" >> "$REPO_LIST"
echo "$NOW | $PWD | synced to $platform as $repo" >> "$LOG_FILE"

# ðŸ•’ Sync setup unless disabled
if [[ "$disable_sync" != "true" ]]; then
  if [[ "$OSTYPE" == "darwin"* ]]; then
    plist="$HOME/Library/LaunchAgents/com.create-repo.auto.plist"
    cat > "$plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.create-repo.auto</string>
  <key>ProgramArguments</key>
  <array>
    <string>$SCRIPT_PATH</string>
  </array>
  <key>StartInterval</key>
  <integer>$((default_cron_interval * 60))</integer>
  <key>RunAtLoad</key>
  <true/>
</dict>
</plist>
EOF
    launchctl unload "$plist" &>/dev/null || true
    launchctl load "$plist"
  else
    (crontab -l 2>/dev/null; echo "*/${default_cron_interval:-1} * * * * $SCRIPT_PATH # auto-sync by create-repo") \
    | sort -u | crontab -
  fi
fi

# âœ… Done
echo ""
echo -e "${GREEN}ðŸŽ‰ '$repo' synced with $platform!${RESET}"
echo "ðŸ“ $PWD"
echo "ðŸ“ Tracked in: $REPO_LIST"
echo "ðŸ§© Platform binding: $PLATFORM_MAP"
[ "$disable_sync" = "true" ] && echo "ðŸ›‘ Syncing disabled via local config"

# ðŸ”” Notify
command -v notify-send &>/dev/null && notify-send "create-repo" "Repo '$repo' synced to $platform."
