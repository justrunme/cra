#!/bin/bash
set -e

CONFIG_FILE="$HOME/.create-repo.conf"
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

mkdir -p ~/.create-repo/templates

# ðŸ”§ Ð¤Ð»Ð°Ð³Ð¸
show_help=false
show_version=false
run_update=false
run_clean=false
dry_run=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --help|-h) show_help=true ; shift ;;
    --version) show_version=true ; shift ;;
    --update) run_update=true ; shift ;;
    --clean) run_clean=true ; shift ;;
    --dry-run) dry_run=true ; shift ;;
    *) repo=$1; shift ;;
  esac
done

# ðŸ“¦ Ð’ÐµÑ€ÑÐ¸Ñ
if $show_version; then
  VERSION=$(dpkg -s create-repo-auto 2>/dev/null | grep '^Version:' | awk '{print $2}')
  echo "create-repo version ${VERSION:-unknown}"
  exit 0
fi

# ðŸ“˜ --help
if $show_help; then
  echo "ðŸ“¦ create-repo â€” Ð°Ð²Ñ‚Ð¾Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
  echo ""
  echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:"
  echo "  create-repo [Ð¸Ð¼Ñ] [Ð¾Ð¿Ñ†Ð¸Ð¸]"
  echo ""
  echo "ÐžÐ¿Ñ†Ð¸Ð¸:"
  echo "  --update       ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ (.deb Ð¸Ð· GitHub)"
  echo "  --clean        Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð½ÐµÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿ÑƒÑ‚Ð¸ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° Ð°Ð²Ñ‚Ð¾ÑÐ»ÐµÐ¶ÐµÐ½Ð¸Ñ"
  echo "  --dry-run      Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ð±ÐµÐ· Ð¿ÑƒÑˆÐ° Ð¸ cron"
  echo "  --version      ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ"
  echo "  --help         ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ"
  exit 0
fi

# ðŸ“‚ ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
repo=${repo:-$(basename "$PWD")}
platform=""
REPO_LIST="$HOME/.repo-autosync.list"
SCRIPT_PATH="/usr/local/bin/update-all"
default_visibility=${default_visibility:-public}
default_cron_interval=${default_cron_interval:-1}

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
command -v git >/dev/null || { echo "âŒ Git Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"; exit 1; }
command -v curl >/dev/null || { echo "âŒ Curl Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"; exit 1; }
command -v crontab >/dev/null || { echo "âŒ Crontab Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"; exit 1; }

# ðŸŒ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
if command -v gh &>/dev/null; then
  platform="github"
elif [ -n "$GITLAB_TOKEN" ]; then
  platform="gitlab"
elif [[ -n "$BITBUCKET_USERNAME" && -n "$BITBUCKET_APP_PASSWORD" ]]; then
  platform="bitbucket"
else
  echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð°Ñ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ."
  echo ""
  echo "ðŸ›  Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ:"
  echo ""
  echo "ðŸ”¹ GitHub:"
  echo "   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ GitHub CLI:"
  echo "     sudo apt install gh"
  echo "   Ð˜ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐ¹Ñ‚ÐµÑÑŒ:"
  echo "     gh auth login"
  echo ""
  echo "ðŸ”¹ GitLab:"
  echo "   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ:"
  echo "     export GITLAB_TOKEN=your_token"
  echo ""
  echo "ðŸ”¹ Bitbucket:"
  echo "   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ:"
  echo "     export BITBUCKET_USERNAME=your_username"
  echo "     export BITBUCKET_APP_PASSWORD=your_app_password"
  echo ""
  exit 1
fi

# ðŸ› ï¸ Git
if [ ! -d .git ]; then
  git init && git checkout -b main
else
  git checkout main 2>/dev/null || git checkout -b main
fi

[ ! -f README.md ] && echo "# $repo" > README.md
[ ! -f .gitignore ] && echo ".DS_Store" > .gitignore

git add .
NOW=$(date "+%Y-%m-%d %H:%M:%S")
git commit -m "Initial commit at $NOW" 2>/dev/null || true

# ðŸŒ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
if [[ "$platform" == "github" ]]; then
  remote_url="git@github.com:$(gh api user --jq .login)/$repo.git"
  if ! gh repo view "$repo" &>/dev/null; then
    gh repo create "$repo" --$default_visibility --source=. --push
  fi

elif [[ "$platform" == "gitlab" ]]; then
  response=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
    --data "name=$repo&visibility=$default_visibility" \
    https://gitlab.com/api/v4/projects)
  remote_url=$(echo "$response" | grep -oP '"ssh_url_to_repo":"\K[^"]+')
  [ -z "$remote_url" ] && { echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ð° GitLab"; exit 1; }

elif [[ "$platform" == "bitbucket" ]]; then
  echo "ðŸ“¡ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ð° Bitbucket..."
  response=$(curl -s -u "$BITBUCKET_USERNAME:$BITBUCKET_APP_PASSWORD" \
    -X POST "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_USERNAME/$repo" \
    -H "Content-Type: application/json" \
    -d "{\"scm\": \"git\", \"is_private\": $( [[ "$default_visibility" == "private" ]] && echo true || echo false ) }")
  remote_url="git@bitbucket.org:$BITBUCKET_USERNAME/$repo.git"
fi

# ðŸ”— Remote Ð¸ Push
git remote get-url origin &>/dev/null || git remote add origin "$remote_url"
git branch --set-upstream-to=origin/main main 2>/dev/null
git push -u origin main

# ðŸ“‹ Ð’ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ»ÐµÐ¶ÐµÐ½Ð¸Ñ
grep -qxF "$PWD" "$REPO_LIST" 2>/dev/null || echo "$PWD" >> "$REPO_LIST"

# â± Cron
TMP_CRON=$(mktemp)
crontab -l 2>/dev/null | grep -v 'update-all' > "$TMP_CRON"
echo "*/$default_cron_interval * * * * /usr/local/bin/update-all" >> "$TMP_CRON"
sort -u "$TMP_CRON" -o "$TMP_CRON"
crontab "$TMP_CRON"
rm "$TMP_CRON"
