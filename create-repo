#!/bin/bash

CONFIG_FILE="$HOME/.create-repo.conf"
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

mkdir -p ~/.create-repo/templates

# –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
if command -v gh &>/dev/null; then
  default_platform="github"
elif [ -n "$GITLAB_TOKEN" ]; then
  default_platform="gitlab"
else
  echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ gh –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é GITLAB_TOKEN"
  exit 1
fi

default_cron_interval=${default_cron_interval:-1}
default_visibility=${default_visibility:-public}

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $PWD"
read -p "üî§ –ò–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $(basename $PWD)): " repo
repo=${repo:-$(basename "$PWD")}

platform=${default_platform}
echo "üåê –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤—ã–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: $platform"

if ! command -v git &>/dev/null; then
  echo "‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  exit 1
fi

if [ ! -d .git ]; then
  git init
  git checkout -b main
else
  git checkout main 2>/dev/null || git checkout -b main
fi

# README
if [ ! -f README.md ]; then
  template="$HOME/.create-repo/templates/${platform}.README.md"
  if [ -f "$template" ]; then
    cp "$template" README.md
  else
    echo "# $repo" > README.md
  fi
fi

# .gitignore
if [ ! -f .gitignore ]; then
  if [ -f "$HOME/.create-repo/templates/${platform}.gitignore" ]; then
    cp "$HOME/.create-repo/templates/${platform}.gitignore" .gitignore
  else
    echo ".DS_Store" > .gitignore
  fi
fi

git add .
git commit -m "Initial commit"
git remote add origin git@github.com:justrunme/$repo.git
git push -u origin main

echo "$PWD" >> ~/.repo-autosync.list
sort -u ~/.repo-autosync.list -o ~/.repo-autosync.list

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ cron
cron_interval=$default_cron_interval
crontab -l 2>/dev/null | grep -v 'update-all' > /tmp/current_cron

if ! grep -q "/usr/local/bin/update-all" /tmp/current_cron; then
  echo "*/$cron_interval * * * * /usr/local/bin/update-all" >> /tmp/current_cron
  echo "‚úÖ Cron-–∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞"
else
  echo "‚ÑπÔ∏è Cron-–∑–∞–¥–∞—á–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

crontab /tmp/current_cron
rm /tmp/current_cron
