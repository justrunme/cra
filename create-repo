#!/bin/bash
set -e

# üé® –¶–≤–µ—Ç–∞
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
BLUE="\e[34m"
RESET="\e[0m"

# üìÅ –ü—É—Ç–∏
CONFIG_FILE="$HOME/.create-repo.conf"
REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
ERROR_LOG="$HOME/.create-repo-errors.log"
SCRIPT_PATH="/usr/local/bin/update-all"
NOW=$(date "+%Y-%m-%d %H:%M:%S")

# üåü –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ = –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤
if [ ! -f "$CONFIG_FILE" ]; then
  echo -e "${BLUE}‚ú® –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ create-repo ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏–º –≤—Å—ë –≤–º–µ—Å—Ç–µ!${RESET}"
  interactive=true
else
  source "$CONFIG_FILE"
  interactive=false
fi

# üö© –§–ª–∞–≥–∏
show_help=false
run_update=false
repo=""

# üéØ –ê—Ä–≥—É–º–µ–Ω—Ç—ã
while [[ $# -gt 0 ]]; do
  case $1 in
    --help|-h) show_help=true ; shift ;;
    --update|--self-update) run_update=true ; shift ;;
    *) repo=$1 ; shift ;;
  esac
done

# üÜò –°–ø—Ä–∞–≤–∫–∞
if $show_help; then
  echo -e "${BLUE}üì¶ create-repo ‚Äî CLI-—É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è Git-–ø—Ä–æ–µ–∫—Ç–æ–≤${RESET}"
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: create-repo [–∏–º—è] [–æ–ø—Ü–∏–∏]"
  echo "–û–ø—Ü–∏–∏: --update --help"
  exit 0
fi

# ‚¨ÜÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
if $run_update; then
  echo -e "${BLUE}‚¨ÜÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ create-repo...${RESET}"
  latest_url=$(curl -s https://api.github.com/repos/justrunme/cra/releases/latest \
    | grep browser_download_url | grep .deb | cut -d '"' -f 4)
  if [[ -n "$latest_url" ]]; then
    tmp_deb=$(mktemp)
    curl -L "$latest_url" -o "$tmp_deb"
    if sudo dpkg -i "$tmp_deb"; then
      echo -e "${GREEN}‚úÖ –£—Ç–∏–ª–∏—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!${RESET}"
    else
      echo "$NOW | ERROR installing update" >> "$ERROR_LOG"
      echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è${RESET}"
    fi
    rm -f "$tmp_deb"
  else
    echo "$NOW | ERROR fetching update URL" >> "$ERROR_LOG"
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ${RESET}"
  fi
  exit 0
fi

# üß© –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)
if $interactive; then
  echo ""
  echo -ne "${YELLOW}üì¶ –í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è [$(basename "$PWD")]: ${RESET}"
  read input_repo
  repo=${input_repo:-$(basename "$PWD")}

  echo -ne "${YELLOW}üîê –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (public/private) [public]: ${RESET}"
  read visibility_input
  default_visibility=${visibility_input:-public}

  echo -ne "${YELLOW}üë• –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É GitHub (–µ—Å–ª–∏ –µ—Å—Ç—å) [none]: ${RESET}"
  read input_team
  default_team=${input_team:-}

  echo -ne "${YELLOW}‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö [1]: ${RESET}"
  read interval_input
  default_cron_interval=${interval_input:-1}

  # üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
  cat > "$CONFIG_FILE" <<EOF
# ~/.create-repo.conf ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Ç–∏–ª–∏—Ç—ã create-repo
# –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ.

# üîê –¢–∏–ø —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: public (–ø—É–±–ª–∏—á–Ω—ã–π) –∏–ª–∏ private (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
default_visibility=$default_visibility

# ‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö
default_cron_interval=$default_cron_interval

# üë• –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã GitHub (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
default_team=$default_team
EOF

  echo ""
  echo -e "${GREEN}‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ $CONFIG_FILE${RESET}"
  echo -e "üìå –û–Ω–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–∞—Ö."
  echo -e "‚úèÔ∏è  –ò–∑–º–µ–Ω–∏—Ç—å –∏—Ö –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é: ${YELLOW}nano ~/.create-repo.conf${RESET}"
  echo ""
fi

# üîê –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
notify() {
  msg="$1"
  if command -v notify-send &>/dev/null; then
    notify-send "create-repo" "$msg"
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    osascript -e "display notification \"$msg\" with title \"create-repo\""
  elif grep -qEi "(Microsoft|WSL)" /proc/version &>/dev/null; then
    powershell.exe -Command "[System.Windows.Forms.MessageBox]::Show('$msg','create-repo')" 2>/dev/null || true
  fi
}

# üì¶ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
if command -v gh &>/dev/null; then
  platform="github"
elif [ -n "$GITLAB_TOKEN" ]; then
  platform="gitlab"
elif [[ -n "$BITBUCKET_USERNAME" && -n "$BITBUCKET_APP_PASSWORD" ]]; then
  platform="bitbucket"
else
  echo -e "${RED}‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π${RESET}"
  exit 1
fi

echo -e "${GREEN}‚úÖ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: $platform${RESET}"

# üîß Git init
if [ ! -d .git ]; then
  git init
  git checkout -b main
  current_branch="main"
else
  current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")
  git checkout "$current_branch" 2>/dev/null || git checkout -b main
fi

[ ! -f README.md ] && echo "# $repo" > README.md
[ ! -f .gitignore ] && echo ".DS_Store" > .gitignore
git add .
committed=false
git commit -m "Initial commit at $NOW" &>/dev/null && committed=true || true

# üõ∞Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
if [[ "$platform" == "github" ]]; then
  user=$(gh api user --jq .login)
  remote_url="git@github.com:$user/$repo.git"
  if ! gh repo view "$repo" &>/dev/null; then
    args="--$default_visibility --source=."
    [[ -n "$default_team" ]] && args="$args --team $default_team"
    gh repo create "$repo" $args --push || {
      echo "$NOW | ERROR creating GitHub repo '$repo'" >> "$ERROR_LOG"
      notify "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
      exit 1
    }
  fi
elif [[ "$platform" == "gitlab" ]]; then
  response=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
    --data "name=$repo&visibility=$default_visibility" https://gitlab.com/api/v4/projects)
  remote_url=$(echo "$response" | grep -oP '"ssh_url_to_repo":"\K[^"]+')
elif [[ "$platform" == "bitbucket" ]]; then
  curl -s -u "$BITBUCKET_USERNAME:$BITBUCKET_APP_PASSWORD" \
    -X POST "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_USERNAME/$repo" \
    -H "Content-Type: application/json" \
    -d "{\"scm\": \"git\", \"is_private\": $( [[ "$default_visibility" == "private" ]] && echo true || echo false ) }"
  remote_url="git@bitbucket.org:$BITBUCKET_USERNAME/$repo.git"
fi

git remote get-url origin &>/dev/null || git remote add origin "$remote_url"
git push -u origin "$current_branch" &>/dev/null && pushed=true || pushed=false

# üì§ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "$NOW | $PWD | synced to $platform as $repo" >> "$LOG_FILE"

# üìù –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
grep -qxF "$PWD" "$REPO_LIST" || echo "$PWD" >> "$REPO_LIST"

# ‚è±Ô∏è Cron / Launchctl
if [[ "$OSTYPE" == "darwin"* ]]; then
  plist="$HOME/Library/LaunchAgents/com.create-repo.auto.plist"
  cat > "$plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.create-repo.auto</string>
  <key>ProgramArguments</key>
  <array>
    <string>$SCRIPT_PATH</string>
  </array>
  <key>StartInterval</key>
  <integer>$((default_cron_interval * 60))</integer>
  <key>RunAtLoad</key>
  <true/>
</dict>
</plist>
EOF
  launchctl unload "$plist" &>/dev/null || true
  launchctl load "$plist"
else
  TMP_CRON=$(mktemp)
  crontab -l 2>/dev/null | grep -v "$SCRIPT_PATH" > "$TMP_CRON"
  echo "*/$default_cron_interval * * * * $SCRIPT_PATH # auto-sync by create-repo" >> "$TMP_CRON"
  sort -u "$TMP_CRON" -o "$TMP_CRON"
  crontab "$TMP_CRON"
  rm "$TMP_CRON"
fi

# ‚úÖ –§–∏–Ω–∞–ª
echo ""
echo -e "${GREEN}üéâ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π '$repo' —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å $platform${RESET}"
echo "üìÅ –ü—É—Ç—å: $PWD"
echo "üìù –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è: $REPO_LIST"
echo "‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª: $default_cron_interval –º–∏–Ω"
echo "‚ÑπÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏: nano ~/.create-repo.conf"

notify "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è '$repo' –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
