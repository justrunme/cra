#!/bin/bash

CONFIG_FILE="$HOME/.create-repo.conf"
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

mkdir -p ~/.create-repo/templates

# ะะฒัะพะพะฟัะตะดะตะปะตะฝะธะต ะฟะปะฐััะพัะผั
if command -v gh &>/dev/null; then
  default_platform="github"
elif [ -n "$GITLAB_TOKEN" ]; then
  default_platform="gitlab"
else
  echo "โ ะะต ะฝะฐะนะดะตะฝะฐ ะฟะปะฐััะพัะผะฐ. ะฃััะฐะฝะพะฒะธัะต gh ะธะปะธ ะฟะตัะตะผะตะฝะฝัั GITLAB_TOKEN"
  exit 1
fi

platform=${default_platform}
default_cron_interval=${default_cron_interval:-1}
default_visibility=${default_visibility:-public}

# โ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
missing=""
check_dep() {
  if ! command -v "$1" &>/dev/null; then
    echo "โ ะะต ะฝะฐะนะดะตะฝะพ: $1"
    missing+=" $1"
  else
    echo "โ ะะฐะนะดะตะฝะพ: $1"
  fi
}
check_dep git
check_dep curl
check_dep crontab

if [[ "$platform" == "github" ]]; then
  check_dep gh
fi

if ! command -v notify-send &>/dev/null; then
  echo "โน๏ธ ะะต ะฝะฐะนะดะตะฝะพ: notify-send (ะฝะตะพะฑัะทะฐัะตะปัะฝะพ, ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน)"
fi
if ! command -v dpkg &>/dev/null; then
  echo "โน๏ธ ะะต ะฝะฐะนะดะตะฝะพ: dpkg (ะฝัะถะฝะพ ะดะปั .deb-ะพะฑะฝะพะฒะปะตะฝะธะน)"
fi

if [ -n "$missing" ]; then
  echo ""
  echo "โ๏ธ ะะตะพะฑัะพะดะธะผัะต ะฟะฐะบะตัั ะฝะต ะฝะฐะนะดะตะฝั:$missing"
  echo "๐ก ะฃััะฐะฝะพะฒะธ ะธั: sudo apt install$missing"
  exit 1
fi

# ๐ ะะฟัะตะดะตะปะตะฝะธะต ัะตะฟะพะทะธัะพัะธั
repo=${1:-$(basename "$PWD")}
echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $PWD"
echo "๐ค ะะผั ัะตะฟะพะทะธัะพัะธั: $repo"

echo "๐ ะะปะฐััะพัะผะฐ ะฒัะฑัะฐะฝะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ: $platform"

# ๐๏ธ ะะฝะธัะธะฐะปะธะทะฐัะธั Git
if [ ! -d .git ]; then
  git init
  git checkout -b main
else
  git checkout main 2>/dev/null || git checkout -b main
fi

# README
if [ ! -f README.md ]; then
  template="$HOME/.create-repo/templates/${platform}.README.md"
  if [ -f "$template" ]; then
    cp "$template" README.md
  else
    echo "# $repo" > README.md
  fi
fi

# .gitignore
if [ ! -f .gitignore ]; then
  if [ -f "$HOME/.create-repo/templates/${platform}.gitignore" ]; then
    cp "$HOME/.create-repo/templates/${platform}.gitignore" .gitignore
  else
    echo ".DS_Store" > .gitignore
  fi
fi

# Git add
git add .
NOW=$(date "+%Y-%m-%d %H:%M:%S")
git commit -m "Initial commit at $NOW" 2>/dev/null || echo "โ๏ธ ะะพะผะผะธั ัะถะต ะฑัะป."

# ๐ ะกะพะทะดะฐะฝะธะต ัะดะฐะปัะฝะฝะพะณะพ ัะตะฟะพะทะธัะพัะธั ะธ push
if [[ "$platform" == "github" ]]; then
  remote_url="git@github.com:justrunme/$repo.git"
  if ! gh repo view "$repo" &>/dev/null; then
    echo "๐ ะกะพะทะดะฐัะผ ัะตะฟะพะทะธัะพัะธะน ะฝะฐ GitHub..."
    gh repo create "$repo" --private --source=. --push
  fi
else
  remote_url=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
    --data "name=$repo&visibility=$default_visibility" \
    https://gitlab.com/api/v4/projects | grep -oP '"ssh_url_to_repo":"\K[^"]+')
fi

# ๐ ะัะพะฒะตัะบะฐ remote
if ! git remote get-url origin &>/dev/null; then
  git remote add origin "$remote_url"
else
  echo "โน๏ธ Remote 'origin' ัะถะต ัััะตััะฒัะตั, ะฟัะพะฟััะบะฐะตะผ ะดะพะฑะฐะฒะปะตะฝะธะต."
fi

# ๐ ะััะปะตะถะธะฒะฐะฝะธะต ะฒะตัะบะธ ะธ push
git branch --set-upstream-to=origin/main main 2>/dev/null

echo "๐ ะัะฟะพะปะฝัะตะผ git push..."
if git push -u origin main 2>/dev/null; then
  echo "โ ะะตะฟะพะทะธัะพัะธะน ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝ ั origin/main"
else
  echo "โ๏ธ ะะต ัะดะฐะปะพัั ะฒัะฟะพะปะฝะธัั push. ะัะพะฒะตัั ะฐะฒัะพัะธะทะฐัะธั ะธะปะธ ะดะพัััะฟ."
fi

# ๐ ะะพะฑะฐะฒะปะตะฝะธะต ะฒ ะฐะฒัะพัะปะตะถะตะฝะธะต
grep -qxF "$PWD" ~/.repo-autosync.list 2>/dev/null || echo "$PWD" >> ~/.repo-autosync.list
sort -u ~/.repo-autosync.list -o ~/.repo-autosync.list

# โฑ๏ธ ะฃััะฐะฝะพะฒะบะฐ cron-ะทะฐะดะฐัะธ
cron_interval=$default_cron_interval
TMP_CRON=$(mktemp)
crontab -l 2>/dev/null | grep -v 'update-all' > "$TMP_CRON"
echo "*/$cron_interval * * * * /usr/local/bin/update-all" >> "$TMP_CRON"
sort -u "$TMP_CRON" -o "$TMP_CRON"
crontab "$TMP_CRON"
rm "$TMP_CRON"
echo "โ Cron-ะทะฐะดะฐัะฐ ะฝะฐัััะพะตะฝะฐ ะฝะฐ ะบะฐะถะดัะต $cron_interval ะผะธะฝ"

# ๐ ะคะธะฝะฐะปัะฝะพะต ัะพะพะฑัะตะฝะธะต
echo ""
echo "๐ ะัั ะณะพัะพะฒะพ!"
echo "๐ ะััั ะฟัะพะตะบัะฐ: $PWD"
echo "๐ ะะปะฐััะพัะผะฐ: $platform"
echo "๐ฆ ะะตะฟะพะทะธัะพัะธะน: $repo"
echo "๐ ะะพะฑะฐะฒะปะตะฝ ะฒ ะฐะฒัะพัะปะตะถะตะฝะธะต: ~/.repo-autosync.list"
echo "โฑ๏ธ Cron-ะทะฐะดะฐัะฐ: ะบะฐะถะดัะต $cron_interval ะผะธะฝ"
