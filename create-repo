#!/bin/bash

CONFIG_FILE="$HOME/.create-repo.conf"
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

mkdir -p ~/.create-repo/templates

# üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–ª–∞–≥–æ–≤
show_status=false
show_log=false
log_lines=20
run_update=false
run_clean=false
dry_run=false
interactive=false
show_help=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --status) show_status=true ; shift ;;
    --log) show_log=true; log_lines="${2:-20}"; shift 2;;
    --update) run_update=true ; shift ;;
    --clean) run_clean=true ; shift ;;
    --dry-run) dry_run=true ; shift ;;
    --interactive) interactive=true ; shift ;;
    -h|--help) show_help=true ; shift ;;
    *) repo=$1; shift ;;
  esac
done

# üìÇ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
SCRIPT_PATH="/usr/local/bin/update-all"

# üÜò --help
if \$show_help; then
  echo "üì¶ create-repo ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Git-–ø—Ä–æ–µ–∫—Ç–æ–≤"
  echo ""
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
  echo "  create-repo [–∏–º—è] [–æ–ø—Ü–∏–∏]"
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --status           –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å cron –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"
  echo "  --log [N]          –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ –∏–∑ –ª–æ–≥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)"
  echo "  --clean            –£–¥–∞–ª–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—É—Ç–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ—Å–ª–µ–∂–µ–Ω–∏—è"
  echo "  --update           –û–±–Ω–æ–≤–∏—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ (.deb –∏–∑ GitHub)"
  echo "  --dry-run          –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞, –±–µ–∑ –ø—É—à–∞ –∏ cron"
  echo "  --interactive      –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏"
  echo "  -h, --help         –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
  echo ""
  echo "üìò –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–µ–∑ —Ñ–ª–∞–≥–æ–≤:"
  echo "  1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (GitHub/GitLab)"
  echo "  2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç git, —Å–æ–∑–¥–∞—ë—Ç –≤–µ—Ç–∫—É main"
  echo "  3. –°–æ–∑–¥–∞—ë—Ç README.md –∏ .gitignore (–∏–∑ —à–∞–±–ª–æ–Ω–∞ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
  echo "  4. –î–µ–ª–∞–µ—Ç commit, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç"
  echo "  5. –°–æ–∑–¥–∞—ë—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub –∏–ª–∏ GitLab, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
  echo "  6. –î–æ–±–∞–≤–ª—è–µ—Ç origin –∏ –ø—É—à–∏—Ç –≤ main"
  echo "  7. –î–æ–±–∞–≤–ª—è–µ—Ç –ø—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ ~/.repo-autosync.list"
  echo "  8. –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É –≤ crontab –¥–ª—è –∞–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (/usr/local/bin/update-all)"
  echo "  9. –í—ã–≤–æ–¥–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –ø—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞"
  echo ""
  exit 0
fi

# (–¥–∞–ª–µ–µ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

# –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–ª–∞–≥–æ–≤ –∏ –Ω–µ—Ç –∏–º–µ–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∫–∞–∫ –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
repo=$(basename "$PWD")
echo "üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $repo"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
if command -v gh &>/dev/null; then
  default_platform="github"
elif [ -n "$GITLAB_TOKEN" ]; then
  default_platform="gitlab"
else
  default_platform="‚ùå –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ (—É—Å—Ç–∞–Ω–æ–≤–∏ gh –∏–ª–∏ GITLAB_TOKEN)"
fi
platform=${default_platform}

default_visibility=${default_visibility:-public}
default_cron_interval=${default_cron_interval:-1}

echo "üåê –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: $platform"
echo "üîí –í–∏–¥–∏–º–æ—Å—Ç—å: $default_visibility"
echo "‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª cron: $default_cron_interval –º–∏–Ω"
