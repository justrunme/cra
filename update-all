#!/bin/bash

REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
ERROR_LOG="$HOME/.create-repo-errors.log"

# ðŸŽ¨ Colors
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
BLUE="\e[34m"
RESET="\e[0m"

# ðŸ§  Load .env if present
load_env() {
  [ -f .env ] && export $(grep -v '^#' .env | xargs)
}

# ðŸ” Detect branch (main/master)
detect_branch() {
  git rev-parse --verify main &>/dev/null && echo "main" && return
  git rev-parse --verify master &>/dev/null && echo "master" && return
  echo "main"
}

# ðŸ”” Desktop notification
notify() {
  msg="$1"
  if command -v notify-send &>/dev/null; then
    notify-send "create-repo" "$msg"
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    osascript -e "display notification \"$msg\" with title \"create-repo\""
  elif grep -qEi "(Microsoft|WSL)" /proc/version &>/dev/null; then
    powershell.exe -Command "New-BurntToastNotification -Text 'create-repo', '$msg'" >/dev/null 2>&1 || true
  fi
}

# ðŸ“„ Create list if missing
[ ! -f "$REPO_LIST" ] && touch "$REPO_LIST"

# ðŸ“‚ Process each repo
mapfile -t REPOS < "$REPO_LIST"

for REPO in "${REPOS[@]}"; do
  echo -e "${BLUE}ðŸ“ Checking: $REPO${RESET}"
  cd "$REPO" || {
    echo -e "${RED}âŒ Cannot access $REPO${RESET}" | tee -a "$ERROR_LOG"
    continue
  }

  # ðŸ›‘ Skip if disable_sync is set
  if [[ -f .create-repo.local.conf ]]; then
    source .create-repo.local.conf
    if [[ "$disable_sync" == "true" ]]; then
      echo -e "${YELLOW}ðŸš« Skipping (disabled in .create-repo.local.conf)${RESET}"
      continue
    fi
  fi

  load_env
  BRANCH=$(detect_branch)
  NOW=$(date "+%Y-%m-%d %H:%M:%S")

  if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
    {
      git add .
      git commit -m "ðŸ” Auto commit at $NOW" || echo -e "${YELLOW}âš ï¸ No changes to commit${RESET}"
      git pull --rebase origin "$BRANCH"
      git push origin "$BRANCH"
      echo "$NOW | âœ… Synced: $REPO" >> "$LOG_FILE"
      notify "âœ… Synced: $REPO"
    } || {
      echo "$NOW | âŒ Sync error: $REPO" >> "$ERROR_LOG"
      echo -e "${RED}âŒ Sync error in $REPO${RESET}"
    }
  else
    echo "$NOW | âœ… No changes: $REPO" >> "$LOG_FILE"
    echo -e "${GREEN}âœ” No changes to sync${RESET}"
  fi

  echo -e "${RESET}-----------------------------"
done
