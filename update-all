#!/bin/bash

REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"

# üóÇÔ∏è –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$REPO_LIST" ]; then
  echo "üìÑ –°–ø–∏—Å–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é..."
  touch "$REPO_LIST"
fi

# –ß–∏—Ç–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π
mapfile -t REPOS < "$REPO_LIST"

for REPO in "${REPOS[@]}"; do
  echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞: $REPO"
  cd "$REPO" || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ $REPO"; continue; }

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
    NOW=$(date "+%Y-%m-%d %H:%M:%S")
    git add .
    git commit -m "üîÅ Auto commit at $NOW" || echo "‚ö†Ô∏è –ù–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å"
    git pull --rebase origin main
    git push origin main
    echo "$NOW | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $REPO" >> "$LOG_FILE"
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
    if command -v notify-send &>/dev/null; then
      notify-send "üü¢ Git Updated" "Push –≤—ã–ø–æ–ª–Ω–µ–Ω: $REPO"
    fi
  else
    NOW=$(date "+%Y-%m-%d %H:%M:%S")
    echo "$NOW | ‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: $REPO" >> "$LOG_FILE"
  fi

  echo "-----------------------------"
done
