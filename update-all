#!/bin/bash

REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
ERROR_LOG="$HOME/.create-repo-errors.log"

# üé® –¶–≤–µ—Ç–∞
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

# üß† –ü–æ–¥–¥–µ—Ä–∂–∫–∞ .env
load_env() {
  [ -f .env ] && export $(grep -v '^#' .env | xargs)
}

# üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏ (main/master)
detect_branch() {
  git rev-parse --verify main &>/dev/null && echo "main" && return
  git rev-parse --verify master &>/dev/null && echo "master" && return
  echo "main"
}

# üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Linux, macOS, WSL)
notify() {
  msg="$1"
  if command -v notify-send &>/dev/null; then
    notify-send "create-repo" "$msg"
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    osascript -e "display notification \"$msg\" with title \"create-repo\""
  elif grep -qEi "(Microsoft|WSL)" /proc/version &>/dev/null; then
    powershell.exe -Command "New-BurntToastNotification -Text 'create-repo', '$msg'" >/dev/null 2>&1 || true
  fi
}

# üìÑ –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–∏—Å–∫–∞ ‚Äî —Å–æ–∑–¥–∞—ë–º
[ ! -f "$REPO_LIST" ] && touch "$REPO_LIST"

# üìÇ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–∞–ø–∫—É
mapfile -t REPOS < "$REPO_LIST"

for REPO in "${REPOS[@]}"; do
  echo -e "${BLUE}üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞: $REPO${RESET}"
  cd "$REPO" || {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ $REPO${RESET}" | tee -a "$ERROR_LOG"
    continue
  }

  load_env
  BRANCH=$(detect_branch)
  NOW=$(date "+%Y-%m-%d %H:%M:%S")

  if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
    {
      git add .
      git commit -m "üîÅ Auto commit at $NOW" || echo -e "${YELLOW}‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞${RESET}"
      git pull --rebase origin "$BRANCH"
      git push origin "$BRANCH"
      echo "$NOW | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $REPO" >> "$LOG_FILE"
      notify "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: $REPO"
    } || {
      echo "$NOW | ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: $REPO" >> "$ERROR_LOG"
    }
  else
    echo "$NOW | ‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: $REPO" >> "$LOG_FILE"
  fi

  echo -e "${RESET}-----------------------------"
done
