#!/bin/bash

REPO_LIST="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
ERROR_LOG="$HOME/.create-repo-errors.log"
CONFIG_FILE="$HOME/.create-repo.conf"

# üé® Colors
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
BLUE="\e[34m"
RESET="\e[0m"

# üß† Load .env if present
load_env() {
  [ -f .env ] && export $(grep -v '^#' .env | xargs)
}

# üì¶ Load config (local has priority)
load_config() {
  local_config=".create-repo.local.conf"
  if [[ -f "$local_config" ]]; then
    source "$local_config"
  elif [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
  fi
}

# üîç Detect branch
detect_branch() {
  if [[ -n "$default_branch" ]]; then
    echo "$default_branch"
  elif git rev-parse --verify main &>/dev/null; then
    echo "main"
  elif git rev-parse --verify master &>/dev/null; then
    echo "master"
  else
    echo "main"
  fi
}

# üîî Notify (Linux/macOS/WSL)
notify() {
  msg="$1"
  if command -v notify-send &>/dev/null; then
    notify-send "create-repo" "$msg"
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    osascript -e "display notification \"$msg\" with title \"create-repo\""
  elif grep -qEi "(Microsoft|WSL)" /proc/version &>/dev/null; then
    powershell.exe -Command "New-BurntToastNotification -Text 'create-repo', '$msg'" >/dev/null 2>&1 || true
  fi
}

# üìù Ensure repo list file exists
[ ! -f "$REPO_LIST" ] && touch "$REPO_LIST"

mapfile -t REPOS < "$REPO_LIST"

for REPO in "${REPOS[@]}"; do
  echo -e "${BLUE}üìÅ Checking: $REPO${RESET}"
  cd "$REPO" || {
    echo -e "${RED}‚ùå Cannot access $REPO${RESET}" | tee -a "$ERROR_LOG"
    continue
  }

  # üîß Load configs
  load_config

  # üõë Check disable flag
  if [[ "$disable_sync" == "true" ]]; then
    echo -e "${YELLOW}üö´ Skipping (disabled in config)${RESET}"
    continue
  fi

  load_env
  BRANCH=$(detect_branch)
  NOW=$(date "+%Y-%m-%d %H:%M:%S")

  if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
    {
      git add .
      git commit -m "üîÅ Auto commit at $NOW" || echo -e "${YELLOW}‚ö†Ô∏è Nothing to commit${RESET}"
      git pull --rebase origin "$BRANCH"
      git push origin "$BRANCH"
      echo "$NOW | ‚úÖ Synced: $REPO" >> "$LOG_FILE"
      echo -e "${GREEN}‚úî Synced: $REPO${RESET}"
      notify "‚úÖ Synced: $(basename "$REPO")"
    } || {
      echo "$NOW | ‚ùå Sync error: $REPO" >> "$ERROR_LOG"
      echo -e "${RED}‚ùå Sync error in $REPO${RESET}"
    }
  else
    echo "$NOW | ‚úÖ No changes: $REPO" >> "$LOG_FILE"
    echo -e "${GREEN}‚úî No changes to sync${RESET}"
  fi

  echo -e "${RESET}-----------------------------"
done
